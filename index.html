<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arizona ZIP Codes - Shaded Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      background: white;
      padding: .5rem .75rem;
      border-radius: .5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .leaflet-tooltip.zip-label {
      font-weight: 600;
      background: rgba(255,255,255,.85);
      border: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
      padding: 2px 6px;
    }
    .search-container {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .search-input {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      width: 250px;
      font-size: 14px;
      outline: none;
    }
    .search-input:focus {
      border-color: #007cff;
      box-shadow: 0 0 0 2px rgba(0,124,255,.2);
    }
    .search-button {
      background: #007cff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      margin-left: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .search-button:hover {
      background: #0056b3;
    }
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .search-result-item {
      padding: 4px 0;
      font-size: 13px;
      color: #333;
      display: flex;
      align-items: center;
    }
    .search-result-item:hover {
      background: #f5f5f5;
      padding: 4px 6px;
      margin: 0 -6px;
      border-radius: 3px;
    }
    .saved-points-container {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div id="map" aria-label="Map of Arizona ZIP codes"></div>
<div class="search-container">
  <input type="text" class="search-input" placeholder="Search for businesses (e.g., restaurants, gas stations, pharmacies)" id="searchInput">
  <button class="search-button" onclick="searchBusinesses()">Search</button>
  <div class="search-results" id="searchResults"></div>
</div>
<div class="saved-points-container">
  <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Saved Points</div>
  <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Click map to save points</div>
  <div id="savedPointsList"></div>
  <button onclick="clearAllSavedPoints()" style="margin-top: 8px; padding: 4px 8px; font-size: 12px; background: #d62728; color: white; border: none; border-radius: 3px; cursor: pointer; width: 100%;">Clear All</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(async function () {
  // Base map
  const map = L.map('map', { scrollWheelZoom: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Target ZIPs
  const wanted = new Set(["85118", "85119", "85120", "85140", "85142", "85144", "85147", "85201", "85202", "85203", "85204", "85205", "85210", "85213", "85215", "85248", "85249", "85256", "85286"]);

  // Source: OpenDataDE state ZIP GeoJSON (derived from Census ZCTA shapefiles)
  const src = "https://raw.githubusercontent.com/OpenDataDE/State-zip-code-GeoJSON/master/az_arizona_zip_codes_geo.min.json";

  // Fetch and filter features for our ZIPs
  let gj;
  try {
    const res = await fetch(src);
    gj = await res.json();
  } catch (e) {
    alert("Failed to load ZIP boundaries.\nPlease ensure you are online.\n" + e);
    return;
  }

  const features = (gj.features || []).filter(f => {
    const p = f.properties || {};
    const zip = p.ZCTA5CE10 || p.ZCTA5CE || p.zip || p.ZIPCODE || p.ZIP || p.postalCode;
    return zip && wanted.has(String(zip));
  });

  const colorMap = { 
    "85118": "#e41a1c", "85119": "#377eb8", "85120": "#4daf4a", "85140": "#984ea3", 
    "85142": "#ff7f00", "85144": "#1f77b4", "85147": "#ff7f0e", "85201": "#2ca02c", 
    "85202": "#d62728", "85203": "#9467bd", "85204": "#8c564b", "85205": "#e377c2", 
    "85210": "#7f7f7f", "85213": "#bcbd22", "85215": "#17becf", "85248": "#aec7e8", 
    "85249": "#ffbb78", "85256": "#98df8a", "85286": "#ff9896" 
  };

  // Hard-coded mapping of ZIP codes to town/city names
  const zipTownMap = {
    "85118": "Gold Canyon",
    "85119": "Apache Junction",
    "85120": "Apache Junction",
    "85140": "Queen Creek/San Tan Valley",
    "85142": "Queen Creek",
    "85144": "San Tan Valley",
    "85147": "Sacaton",
    "85201": "Mesa",
    "85202": "Mesa",
    "85203": "Mesa",
    "85204": "Mesa",
    "85205": "Mesa",
    "85210": "Mesa",
    "85213": "Mesa",
    "85215": "Mesa",
    "85248": "Chandler",
    "85249": "Chandler",
    "85256": "Scottsdale",
    "85286": "Chandler"
  };

  const layer = L.geoJSON(features, {
    style: f => ({
      color: "#222",
      weight: 1.5,
      fillColor: colorMap[String(
        (f.properties && (f.properties.ZCTA5CE10 || f.properties.ZCTA5CE || f.properties.zip || f.properties.ZIPCODE || f.properties.ZIP || f.properties.postalCode))
      )] || "#8e44ad",
      fillOpacity: 0.35
    }),
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      const zip = p.ZCTA5CE10 || p.ZCTA5CE || p.zip || p.ZIPCODE || p.ZIP || p.postalCode || "ZIP";
      const name = zipTownMap[String(zip)] || "";
      
      layer.bindPopup(`<strong>ZIP ${zip}</strong>${name ? " â€“ " + name : ""}`);
      // Add a lightweight label at the polygon's center
      try {
        const center = layer.getBounds().getCenter();
        L.tooltip({permanent:true, direction:'center', className:'zip-label'})
          .setContent(zip)
          .setLatLng(center)
          .addTo(map);
      } catch {}
    }
  }).addTo(map);

  // Fit to bounds
  if (features.length) {
    map.fitBounds(layer.getBounds(), { padding: [20,20] });
  } else {
    map.setView([33.3, -111.8], 10); // Arizona Phoenix metro area fallback
  }

  // Legend
  const legend = L.control({ position: 'topright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div style="margin-bottom:.25rem;"><strong>Shaded ZIPs v5</strong></div>
      ${Object.entries(colorMap).map(([zip, color]) => {
        const townName = zipTownMap[zip] || '';
        const displayText = townName ? `${zip} - ${townName}` : zip;
        return `<div style="margin-bottom:2px;"><span style="display:inline-block;width:12px;height:12px;background:${color};border:1px solid #222;margin-right:6px;vertical-align:middle;"></span><span style="font-size:13px;">${displayText}</span></div>`;
      }).join('')}
      <div style="margin-top:.5rem;font-size:12px;color:#555;">Boundaries: OpenDataDE (Census ZCTA)</div>
    `;
    return div;
  };
  legend.addTo(map);

  // Search functionality
  let searchMarkers = [];
  
  // Saved points functionality
  let savedMarkers = [];
  const STORAGE_KEY = 'mapSavedPoints';
  
  // Load saved points from local storage
  function loadSavedPoints() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      const points = saved ? JSON.parse(saved) : [];
      // Ensure backward compatibility by adding default color to existing points
      return points.map(point => ({
        ...point,
        color: point.color || '#d62728'
      }));
    } catch (e) {
      console.error('Error loading saved points:', e);
      return [];
    }
  }
  
  // Create a colored marker icon
  function createColoredMarkerIcon(color) {
    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div style="
        background-color: ${color};
        width: 25px;
        height: 25px;
        border-radius: 50% 50% 50% 0;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transform: rotate(-45deg);
        position: relative;
      ">
        <div style="
          width: 6px;
          height: 6px;
          background-color: white;
          border-radius: 50%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(45deg);
        "></div>
      </div>`,
      iconSize: [25, 25],
      iconAnchor: [12, 24]
    });
  }
  
  // Save points to local storage
  function saveSavedPoints(points) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    } catch (e) {
      console.error('Error saving points:', e);
    }
  }
  
  // Add a saved point
  function addSavedPoint(lat, lng, name = '', color = '#d62728') {
    const point = {
      id: Date.now(),
      lat: lat,
      lng: lng,
      name: name || `Point ${Date.now()}`,
      color: color,
      timestamp: new Date().toISOString()
    };
    
    const savedPoints = loadSavedPoints();
    savedPoints.push(point);
    saveSavedPoints(savedPoints);
    
    // Create marker with custom color
    const marker = L.marker([lat, lng], {
      draggable: true,
      icon: createColoredMarkerIcon(point.color)
    }).addTo(map);
    
    marker.bindPopup(`
      <div>
        <strong>${point.name}</strong><br>
        <small>Saved: ${new Date(point.timestamp).toLocaleString()}</small><br>
        <button onclick="editSavedPoint(${point.id})" style="margin-top: 5px; margin-right: 5px; padding: 2px 6px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Edit</button>
        <button onclick="removeSavedPoint(${point.id})" style="margin-top: 5px; padding: 2px 6px; font-size: 11px; background: #d62728; color: white; border: none; border-radius: 3px; cursor: pointer;">Remove</button>
      </div>
    `);
    
    // Update marker position when dragged
    marker.on('dragend', function() {
      const newPos = marker.getLatLng();
      updateSavedPointPosition(point.id, newPos.lat, newPos.lng);
    });
    
    marker.pointId = point.id;
    savedMarkers.push(marker);
    
    updateSavedPointsList();
    return point;
  }
  
  // Remove a saved point
  function removeSavedPoint(pointId) {
    const savedPoints = loadSavedPoints();
    const filteredPoints = savedPoints.filter(p => p.id !== pointId);
    saveSavedPoints(filteredPoints);
    
    // Remove marker from map
    const markerIndex = savedMarkers.findIndex(m => m.pointId === pointId);
    if (markerIndex >= 0) {
      map.removeLayer(savedMarkers[markerIndex]);
      savedMarkers.splice(markerIndex, 1);
    }
    
    updateSavedPointsList();
  }
  
  // Update saved point position
  function updateSavedPointPosition(pointId, newLat, newLng) {
    const savedPoints = loadSavedPoints();
    const point = savedPoints.find(p => p.id === pointId);
    if (point) {
      point.lat = newLat;
      point.lng = newLng;
      saveSavedPoints(savedPoints);
    }
  }
  
  // Load and display all saved points
  function displaySavedPoints() {
    const savedPoints = loadSavedPoints();
    savedPoints.forEach(point => {
      const marker = L.marker([point.lat, point.lng], {
        draggable: true,
        icon: createColoredMarkerIcon(point.color)
      }).addTo(map);
      
      marker.bindPopup(`
        <div>
          <strong>${point.name}</strong><br>
          <small>Saved: ${new Date(point.timestamp).toLocaleString()}</small><br>
          <button onclick="editSavedPoint(${point.id})" style="margin-top: 5px; margin-right: 5px; padding: 2px 6px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Edit</button>
          <button onclick="removeSavedPoint(${point.id})" style="margin-top: 5px; padding: 2px 6px; font-size: 11px; background: #d62728; color: white; border: none; border-radius: 3px; cursor: pointer;">Remove</button>
        </div>
      `);
      
      marker.on('dragend', function() {
        const newPos = marker.getLatLng();
        updateSavedPointPosition(point.id, newPos.lat, newPos.lng);
      });
      
      marker.pointId = point.id;
      savedMarkers.push(marker);
    });
    updateSavedPointsList();
  }
  
  // Update the saved points list in UI
  function updateSavedPointsList() {
    const savedPoints = loadSavedPoints();
    const listDiv = document.getElementById('savedPointsList');
    if (listDiv) {
      if (savedPoints.length === 0) {
        listDiv.innerHTML = '<div style="color: #999; font-size: 12px; font-style: italic;">No saved points</div>';
      } else {
        listDiv.innerHTML = savedPoints.map(point => `
          <div style="padding: 3px 0; border-bottom: 1px solid #eee; font-size: 12px;">
            <div style="font-weight: 600;">${point.name}</div>
            <div style="color: #666; font-size: 11px;">
              ${point.lat.toFixed(5)}, ${point.lng.toFixed(5)}
              <button onclick="zoomToSavedPoint(${point.id})" style="margin-left: 8px; padding: 1px 4px; font-size: 10px; background: #007cff; color: white; border: none; border-radius: 2px; cursor: pointer;">Zoom</button>
              <button onclick="editSavedPoint(${point.id})" style="margin-left: 4px; padding: 1px 4px; font-size: 10px; background: #28a745; color: white; border: none; border-radius: 2px; cursor: pointer;">Edit</button>
              <button onclick="removeSavedPoint(${point.id})" style="margin-left: 4px; padding: 1px 4px; font-size: 10px; background: #d62728; color: white; border: none; border-radius: 2px; cursor: pointer;">Ã—</button>
            </div>
          </div>
        `).join('');
      }
    }
  }
  
  // Zoom to a saved point
  function zoomToSavedPoint(pointId) {
    const savedPoints = loadSavedPoints();
    const point = savedPoints.find(p => p.id === pointId);
    if (point) {
      map.setView([point.lat, point.lng], 16);
      const marker = savedMarkers.find(m => m.pointId === pointId);
      if (marker) {
        marker.openPopup();
      }
    }
  }
  
  // Clear all saved points
  function clearAllSavedPoints() {
    if (confirm('Are you sure you want to remove all saved points?')) {
      // Remove all markers from map
      savedMarkers.forEach(marker => map.removeLayer(marker));
      savedMarkers = [];
      
      // Clear from local storage
      saveSavedPoints([]);
      updateSavedPointsList();
    }
  }
  
  // Add map click handler for saving points
  map.on('click', function(e) {
    const pointName = prompt('Enter a name for this point:');
    if (pointName !== null) { // User didn't cancel
      addSavedPoint(e.latlng.lat, e.latlng.lng, pointName || `Point ${Date.now()}`);
    }
  });
  
  // Load saved points on initialization
  displaySavedPoints();
  
  // Save a search result as a saved point
  window.saveSearchResult = function(index) {
    if (searchMarkers[index]) {
      const marker = searchMarkers[index];
      const result = marker.resultData;
      const name = result.display_name.split(',')[0];
      
      // Add the point to saved points
      addSavedPoint(parseFloat(result.lat), parseFloat(result.lon), name);
      
      // Show confirmation
      marker.bindPopup(`
        <div style="font-weight: 600;">${name}</div>
        <div style="font-size: 12px; margin-top: 4px;">${result.display_name}</div>
        <div style="margin-top: 8px; color: #28a745; font-size: 12px;">
          âœ“ Saved to your points!
        </div>
      `).openPopup();
      
      // Revert popup after 2 seconds
      setTimeout(() => {
        marker.bindPopup(`
          <div style="font-weight: 600;">${name}</div>
          <div style="font-size: 12px; margin-top: 4px;">${result.display_name}</div>
          <div style="margin-top: 8px;">
            <button onclick="saveSearchResult(${index})" style="padding: 4px 8px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Save Point</button>
          </div>
        `);
      }, 2000);
    }
  };
  
  // Edit a saved point name and coordinates
  window.editSavedPoint = function(pointId) {
    const savedPoints = loadSavedPoints();
    const point = savedPoints.find(p => p.id === pointId);
    if (!point) return;
    
    // Create a more detailed edit dialog
    const editDialog = `
      <div style="font-family: system-ui, -apple-system, sans-serif;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px;">Edit Point</h3>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 3px; font-weight: 600; font-size: 12px;">Name:</label>
          <input type="text" id="editName" value="${point.name}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
        </div>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 3px; font-weight: 600; font-size: 12px;">Latitude:</label>
          <input type="number" id="editLat" value="${point.lat}" step="any" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
        </div>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 3px; font-weight: 600; font-size: 12px;">Longitude:</label>
          <input type="number" id="editLng" value="${point.lng}" step="any" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 3px; font-weight: 600; font-size: 12px;">Marker Color:</label>
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="color" id="editColor" value="${point.color}" style="width: 40px; height: 30px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
              <div onclick="document.getElementById('editColor').value='#d62728'" style="width: 20px; height: 20px; background: #d62728; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Red"></div>
              <div onclick="document.getElementById('editColor').value='#2ca02c'" style="width: 20px; height: 20px; background: #2ca02c; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Green"></div>
              <div onclick="document.getElementById('editColor').value='#1f77b4'" style="width: 20px; height: 20px; background: #1f77b4; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Blue"></div>
              <div onclick="document.getElementById('editColor').value='#ff7f0e'" style="width: 20px; height: 20px; background: #ff7f0e; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Orange"></div>
              <div onclick="document.getElementById('editColor').value='#9467bd'" style="width: 20px; height: 20px; background: #9467bd; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Purple"></div>
              <div onclick="document.getElementById('editColor').value='#8c564b'" style="width: 20px; height: 20px; background: #8c564b; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;" title="Brown"></div>
            </div>
          </div>
        </div>
        <div style="text-align: right;">
          <button onclick="cancelEdit()" style="margin-right: 8px; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Cancel</button>
          <button onclick="saveEdit(${point.id})" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Save</button>
        </div>
      </div>
    `;
    
    // Create a modal-like overlay
    const overlay = document.createElement('div');
    overlay.id = 'editOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      min-width: 300px;
      max-width: 400px;
    `;
    
    dialog.innerHTML = editDialog;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Focus the name input
    setTimeout(() => {
      document.getElementById('editName').focus();
      document.getElementById('editName').select();
    }, 100);
  };
  
  // Cancel edit dialog
  window.cancelEdit = function() {
    const overlay = document.getElementById('editOverlay');
    if (overlay) {
      overlay.remove();
    }
  };
  
  // Save edited point
  window.saveEdit = function(pointId) {
    const nameInput = document.getElementById('editName');
    const latInput = document.getElementById('editLat');
    const lngInput = document.getElementById('editLng');
    const colorInput = document.getElementById('editColor');
    
    if (!nameInput || !latInput || !lngInput || !colorInput) return;
    
    const newName = nameInput.value.trim();
    const newLat = parseFloat(latInput.value);
    const newLng = parseFloat(lngInput.value);
    const newColor = colorInput.value;
    
    // Validation
    if (!newName) {
      alert('Please enter a name for the point.');
      nameInput.focus();
      return;
    }
    
    if (isNaN(newLat) || newLat < -90 || newLat > 90) {
      alert('Please enter a valid latitude between -90 and 90.');
      latInput.focus();
      return;
    }
    
    if (isNaN(newLng) || newLng < -180 || newLng > 180) {
      alert('Please enter a valid longitude between -180 and 180.');
      lngInput.focus();
      return;
    }
    
    // Update the saved point
    const savedPoints = loadSavedPoints();
    const point = savedPoints.find(p => p.id === pointId);
    if (point) {
      const oldLat = point.lat;
      const oldLng = point.lng;
      
      point.name = newName;
      point.lat = newLat;
      point.lng = newLng;
      saveSavedPoints(savedPoints);
      
      // Update the marker position and popup if coordinates changed
      const marker = savedMarkers.find(m => m.pointId === pointId);
      if (marker) {
        // Update marker position if coordinates changed
        if (oldLat !== newLat || oldLng !== newLng) {
          marker.setLatLng([newLat, newLng]);
        }
        
        // Update popup content
        marker.bindPopup(`
          <div>
            <strong>${point.name}</strong><br>
            <small>Saved: ${new Date(point.timestamp).toLocaleString()}</small><br>
            <button onclick="editSavedPoint(${point.id})" style="margin-top: 5px; margin-right: 5px; padding: 2px 6px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Edit</button>
            <button onclick="removeSavedPoint(${point.id})" style="margin-top: 5px; padding: 2px 6px; font-size: 11px; background: #d62728; color: white; border: none; border-radius: 3px; cursor: pointer;">Remove</button>
          </div>
        `);
      }
      
      // Update the saved points list
      updateSavedPointsList();
      
      // Close the edit dialog
      cancelEdit();
    }
  };
  
  // Make functions global for onclick handlers
  window.removeSavedPoint = removeSavedPoint;
  window.zoomToSavedPoint = zoomToSavedPoint;
  window.clearAllSavedPoints = clearAllSavedPoints;
  window.editSavedPoint = editSavedPoint;
  window.cancelEdit = cancelEdit;
  window.saveEdit = saveEdit;
  
  window.searchBusinesses = async function() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
      resultsDiv.innerHTML = '<div style="color: #999; font-size: 12px;">Please enter a search term</div>';
      return;
    }
    
    resultsDiv.innerHTML = '<div style="color: #666; font-size: 12px;">Searching...</div>';
    
    // Clear previous search markers
    searchMarkers.forEach(marker => map.removeLayer(marker));
    searchMarkers = [];
    
    try {
      // Get current map bounds to limit search to visible area
      const bounds = map.getBounds();
      const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
      
      // Search using Nominatim API
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&bounded=1&viewbox=${bbox}&limit=10&addressdetails=1&extratags=1`
      );
      
      if (!response.ok) {
        throw new Error('Search failed');
      }
      
      const results = await response.json();
      
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div style="color: #999; font-size: 12px;">No results found</div>';
        return;
      }
      
      // Display results
      resultsDiv.innerHTML = results.map((result, index) => {
        const name = result.display_name.split(',')[0];
        const address = result.display_name.split(',').slice(1, 3).join(',');
        return `
          <div class="search-result-item">
            <div onclick="zoomToResult(${index})" style="flex: 1; cursor: pointer;">
              <div style="font-weight: 600;">${name}</div>
              <div style="font-size: 11px; color: #666;">${address}</div>
            </div>
            <button onclick="saveSearchResult(${index}); event.stopPropagation();" style="margin-left: 8px; padding: 2px 6px; font-size: 10px; background: #28a745; color: white; border: none; border-radius: 2px; cursor: pointer; flex-shrink: 0;">Save</button>
          </div>
        `;
      }).join('');
      
      // Add markers to map
      results.forEach((result, index) => {
        const name = result.display_name.split(',')[0];
        const marker = L.marker([result.lat, result.lon])
          .bindPopup(`
            <div style="font-weight: 600;">${name}</div>
            <div style="font-size: 12px; margin-top: 4px;">${result.display_name}</div>
            <div style="margin-top: 8px;">
              <button onclick="saveSearchResult(${index})" style="padding: 4px 8px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Save Point</button>
            </div>
          `)
          .addTo(map);
        
        searchMarkers.push(marker);
        
        // Store result data on marker for zoom function
        marker.resultData = result;
        marker.resultIndex = index;
      });
      
    } catch (error) {
      resultsDiv.innerHTML = '<div style="color: #d62728; font-size: 12px;">Search error. Please try again.</div>';
      console.error('Search error:', error);
    }
  };
  
  window.zoomToResult = function(index) {
    if (searchMarkers[index]) {
      const marker = searchMarkers[index];
      map.setView([marker.getLatLng().lat, marker.getLatLng().lng], 16);
      marker.openPopup();
    }
  };
  
  // Allow search on Enter key
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchBusinesses();
    }
  });
})();
</script>
</body>
</html>
