<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arizona ZIP Codes - Shaded Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      background: white;
      padding: .5rem .75rem;
      border-radius: .5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .leaflet-tooltip.zip-label {
      font-weight: 600;
      background: rgba(255,255,255,.85);
      border: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
      padding: 2px 6px;
    }
    .search-container {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .search-input {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      width: 250px;
      font-size: 14px;
      outline: none;
    }
    .search-input:focus {
      border-color: #007cff;
      box-shadow: 0 0 0 2px rgba(0,124,255,.2);
    }
    .search-button {
      background: #007cff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      margin-left: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .search-button:hover {
      background: #0056b3;
    }
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .search-result-item {
      padding: 4px 0;
      cursor: pointer;
      font-size: 13px;
      color: #333;
    }
    .search-result-item:hover {
      background: #f5f5f5;
      padding: 4px 6px;
      margin: 0 -6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
<div id="map" aria-label="Map of Arizona ZIP codes"></div>
<div class="search-container">
  <input type="text" class="search-input" placeholder="Search for businesses (e.g., restaurants, gas stations, pharmacies)" id="searchInput">
  <button class="search-button" onclick="searchBusinesses()">Search</button>
  <div class="search-results" id="searchResults"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(async function () {
  // Base map
  const map = L.map('map', { scrollWheelZoom: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Target ZIPs
  const wanted = new Set(["85118", "85119", "85120", "85140", "85142", "85144", "85147", "85201", "85202", "85203", "85204", "85205", "85210", "85213", "85215", "85248", "85249", "85256", "85286"]);

  // Source: OpenDataDE state ZIP GeoJSON (derived from Census ZCTA shapefiles)
  const src = "https://raw.githubusercontent.com/OpenDataDE/State-zip-code-GeoJSON/master/az_arizona_zip_codes_geo.min.json";

  // Fetch and filter features for our ZIPs
  let gj;
  try {
    const res = await fetch(src);
    gj = await res.json();
  } catch (e) {
    alert("Failed to load ZIP boundaries.\nPlease ensure you are online.\n" + e);
    return;
  }

  const features = (gj.features || []).filter(f => {
    const p = f.properties || {};
    const zip = p.ZCTA5CE10 || p.ZCTA5CE || p.zip || p.ZIPCODE || p.ZIP || p.postalCode;
    return zip && wanted.has(String(zip));
  });

  const colorMap = { 
    "85118": "#e41a1c", "85119": "#377eb8", "85120": "#4daf4a", "85140": "#984ea3", 
    "85142": "#ff7f00", "85144": "#1f77b4", "85147": "#ff7f0e", "85201": "#2ca02c", 
    "85202": "#d62728", "85203": "#9467bd", "85204": "#8c564b", "85205": "#e377c2", 
    "85210": "#7f7f7f", "85213": "#bcbd22", "85215": "#17becf", "85248": "#aec7e8", 
    "85249": "#ffbb78", "85256": "#98df8a", "85286": "#ff9896" 
  };

  // Hard-coded mapping of ZIP codes to town/city names
  const zipTownMap = {
    "85118": "Ahwatukee",
    "85119": "Ahwatukee",
    "85120": "Ahwatukee",
    "85140": "Chandler",
    "85142": "Chandler",
    "85144": "Chandler",
    "85147": "Chandler",
    "85201": "Mesa",
    "85202": "Mesa",
    "85203": "Mesa",
    "85204": "Mesa",
    "85205": "Mesa",
    "85210": "Mesa",
    "85213": "Mesa",
    "85215": "Mesa",
    "85248": "Chandler",
    "85249": "Chandler",
    "85256": "Chandler",
    "85286": "Chandler"
  };

  const layer = L.geoJSON(features, {
    style: f => ({
      color: "#222",
      weight: 1.5,
      fillColor: colorMap[String(
        (f.properties && (f.properties.ZCTA5CE10 || f.properties.ZCTA5CE || f.properties.zip || f.properties.ZIPCODE || f.properties.ZIP || f.properties.postalCode))
      )] || "#8e44ad",
      fillOpacity: 0.35
    }),
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      const zip = p.ZCTA5CE10 || p.ZCTA5CE || p.zip || p.ZIPCODE || p.ZIP || p.postalCode || "ZIP";
      const name = zipTownMap[String(zip)] || "";
      
      layer.bindPopup(`<strong>ZIP ${zip}</strong>${name ? " â€“ " + name : ""}`);
      // Add a lightweight label at the polygon's center
      try {
        const center = layer.getBounds().getCenter();
        L.tooltip({permanent:true, direction:'center', className:'zip-label'})
          .setContent(zip)
          .setLatLng(center)
          .addTo(map);
      } catch {}
    }
  }).addTo(map);

  // Fit to bounds
  if (features.length) {
    map.fitBounds(layer.getBounds(), { padding: [20,20] });
  } else {
    map.setView([33.3, -111.8], 10); // Arizona Phoenix metro area fallback
  }

  // Legend
  const legend = L.control({ position: 'topright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div style="margin-bottom:.25rem;"><strong>Shaded ZIPs v4</strong></div>
      ${Object.entries(colorMap).map(([zip, color]) => {
        const townName = zipTownMap[zip] || '';
        const displayText = townName ? `${zip} - ${townName}` : zip;
        return `<div style="margin-bottom:2px;"><span style="display:inline-block;width:12px;height:12px;background:${color};border:1px solid #222;margin-right:6px;vertical-align:middle;"></span><span style="font-size:13px;">${displayText}</span></div>`;
      }).join('')}
      <div style="margin-top:.5rem;font-size:12px;color:#555;">Boundaries: OpenDataDE (Census ZCTA)</div>
    `;
    return div;
  };
  legend.addTo(map);

  // Search functionality
  let searchMarkers = [];
  
  window.searchBusinesses = async function() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
      resultsDiv.innerHTML = '<div style="color: #999; font-size: 12px;">Please enter a search term</div>';
      return;
    }
    
    resultsDiv.innerHTML = '<div style="color: #666; font-size: 12px;">Searching...</div>';
    
    // Clear previous search markers
    searchMarkers.forEach(marker => map.removeLayer(marker));
    searchMarkers = [];
    
    try {
      // Get current map bounds to limit search to visible area
      const bounds = map.getBounds();
      const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
      
      // Search using Nominatim API
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&bounded=1&viewbox=${bbox}&limit=10&addressdetails=1&extratags=1`
      );
      
      if (!response.ok) {
        throw new Error('Search failed');
      }
      
      const results = await response.json();
      
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div style="color: #999; font-size: 12px;">No results found</div>';
        return;
      }
      
      // Display results
      resultsDiv.innerHTML = results.map((result, index) => {
        const name = result.display_name.split(',')[0];
        const address = result.display_name.split(',').slice(1, 3).join(',');
        return `
          <div class="search-result-item" onclick="zoomToResult(${index})">
            <div style="font-weight: 600;">${name}</div>
            <div style="font-size: 11px; color: #666;">${address}</div>
          </div>
        `;
      }).join('');
      
      // Add markers to map
      results.forEach((result, index) => {
        const marker = L.marker([result.lat, result.lon])
          .bindPopup(`
            <div style="font-weight: 600;">${result.display_name.split(',')[0]}</div>
            <div style="font-size: 12px; margin-top: 4px;">${result.display_name}</div>
          `)
          .addTo(map);
        
        searchMarkers.push(marker);
        
        // Store result data on marker for zoom function
        marker.resultData = result;
        marker.resultIndex = index;
      });
      
    } catch (error) {
      resultsDiv.innerHTML = '<div style="color: #d62728; font-size: 12px;">Search error. Please try again.</div>';
      console.error('Search error:', error);
    }
  };
  
  window.zoomToResult = function(index) {
    if (searchMarkers[index]) {
      const marker = searchMarkers[index];
      map.setView([marker.getLatLng().lat, marker.getLatLng().lng], 16);
      marker.openPopup();
    }
  };
  
  // Allow search on Enter key
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchBusinesses();
    }
  });
})();
</script>
</body>
</html>
